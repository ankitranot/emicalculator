<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan (EMI) Calculator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        
        /* --- DESKTOP/DEFAULT STYLES (ORIGINAL STATE) --- */
        body {
            font-family: "Poppins", sans-serif;
            background: #f2f7f3;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            flex-direction: column;
        }

        .top-header-bar {
            width: 100%;
            height: 60px; 
            background-color: transparent; 
            display: flex;
            justify-content: space-between; 
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 1000;
            margin-bottom: 20px; 
            position: relative; 
        }

        .logo-text {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #0b3d1c; 
            text-decoration: none;
        }

        /* Desktop Nav: Visible and Horizontal */
        .top-nav {
            display: flex; 
            gap: 20px; 
            position: static; 
            background: transparent; 
            padding: 0;
        }

        .top-nav a {
            color: #0b3d1c; 
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            padding: 5px 0;
            transition: color 0.3s ease;
        }
        
        /* Hamburger button is HIDDEN on desktop by default */
        #menuToggle {
            display: none;
        }
        /* END DESKTOP/DEFAULT STYLES */

        .card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 950px;
            margin: 0 auto;
        }
        
        .card {
            background: #fff;
            padding: 38px;
            border-radius: 18px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 420px; 
            transition: max-width 0.6s ease, padding 0.6s ease;
            position: relative;
            margin-top: 0;
            box-sizing: border-box;
        }

        .card.expanded {
            max-width: 950px; 
            padding: 38px;
        }

        h2 {
            font-size: 28px;
            margin-bottom: 15px;
            font-weight: 800;
            color: #0b3d1c;
            text-align: center;
        }
        label {
            display: block;
            text-align: left;
            font-weight: 500;
            margin-top: 15px;
            color: #0b3d1c;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ccc;
            border-radius: 12px;
            margin-top: 6px;
            font-size: 15px;
            font-family: "Poppins", sans-serif;
            box-sizing: border-box;
            transition: all 0.2s ease-in-out;
        }
        input:focus {
            border-color: #0b3d1c;
            outline: none;
            box-shadow: 0 0 5px rgba(11, 61, 28, 0.2);
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .btn {
            margin-top: 22px;
            width: 100%;
            padding: 14px;
            background: #0b3d1c;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: "Poppins", sans-serif;
            transition: background 0.3s;
        }
        .btn:hover { background: #062e14; }
        .btn-reset { background: #ff6600; margin-top: 12px; }
        .btn-reset:hover { background: #cc5200; }
        
        .results-and-chart-container {
            display: none; 
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .results-and-chart-container.show {
            display: flex;
        }

        .results-content {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.6;
            text-align: left;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 280px;
            margin-top: 15px;
        }
        canvas { width: 100% !important; height: 100% !important; }
        
        details {
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            background: #f9fdf9;
        }
        summary { font-weight: 600; cursor: pointer; padding: 6px; color: #0b3d1c; }
        summary::marker { color: #ff6600; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 8px;
            /* Give the table a background so it renders correctly in PDF */
            background: #fff; 
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }
        th { background: #0b3d1c; color: #fff; position: sticky; top: 0; }
        .footer {
            color: #000;
            text-align: center;
            padding: 20px 0;
            font-size: 22px;
            font-weight: 800;
            border-top: 6px solid #ff6600;
            border-radius: 10px 10px 0 0;
            margin: 25px 0 25px 0;
            transition: width 0.3s ease;
        }
        
        /* Desktop Layout for Results (Retained) */
        @media (min-width: 769px) {
            .card.expanded .results-and-chart-container.show {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
                gap: 40px;
            }
            .results-content {
                flex: 1;
                order: 0;
            }
            .chart-container {
                flex: 1;
                order: 1;
                height: 350px;
            }
        }

        .result-item {
            margin: 20px 0;
        }
        .result-label {
            font-weight: 600;
            font-size: 20px;
            color: #555;
            display: block;
        }
        .result-value {
            font-size: 32px;
            font-weight: 700;
            color: #0b3d1c;
            display: block;
        }
        .result-label.highlighted {
            font-size: 24px;
        }
        .result-value.highlighted {
            font-size: 44px;
            font-weight: 900;
        }
        .emi-info {
            max-width: 950px;
            margin-top: 30px;
            line-height: 1.6;
            text-align: left; 
        }
        .emi-info h3, .emi-info h4 {
            color: #0b3d1c;
            font-weight: 700;
        }
        .emi-info ul {
            padding-left: 20px;
        }
        
        .schedule-container {
            width: 100%;
            display: none;
        }
        .schedule-container.show {
            display: block;
        }
        
        /* Centering Wrapper for the button */
        .center-btn-wrapper {
            width: 100%;
            display: none; 
            justify-content: center;
            margin-top: 20px; 
        }
        
        .show-schedule-btn {
            background-color: #0b3d1c;
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 0; 
        }
        .show-schedule-btn:hover {
            background-color: #062e14;
        }

        /* --- DOWNLOAD MODAL STYLES --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
            width: 400px;
            position: relative;
        }

        .modal-content h4 {
            color: #0b3d1c;
            font-size: 20px;
            margin-bottom: 15px;
        }

        .modal-content button {
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }

        .modal-download-btn {
            background-color: #ff6600;
            color: #fff;
            border: none;
        }
        .modal-download-btn:hover {
            background-color: #cc5200;
        }
        .modal-close-btn {
            background-color: #ccc;
            color: #333;
            border: none;
        }
        .modal-close-btn:hover {
            background-color: #aaa;
        }
        /* --- END MODAL STYLES --- */

        /* --- START MOBILE OPTIMIZATION (max-width: 768px) --- */
        @media (max-width: 768px) {
            
            body {
                padding: 10px; 
            }
            
            /* Hide the desktop navigation */
            .top-nav {
                display: none; 
                flex-direction: column;
                position: fixed; 
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #fff;
                padding-top: 80px; 
                box-sizing: border-box;
                z-index: 999; 
                overflow-y: auto;
                transition: opacity 0.3s ease;
                gap: 0;
            }

            /* Show the mobile navigation when active */
            .top-nav.active {
                display: flex; 
            }
            
            .top-nav a {
                font-size: 18px; 
                padding: 15px 20px;
                text-align: center;
                border-bottom: 1px solid #f2f7f3; 
            }

            /* --- HAMBURGER MENU STYLES --- */
            /* Show the toggle button */
            #menuToggle {
                display: block;
                width: 30px;
                height: 30px;
                cursor: pointer;
                z-index: 1001;
                background: none;
                border: none;
                padding: 0;
                position: absolute;
                right: 10px; 
            }
            .hamburger-icon, .hamburger-icon::before, .hamburger-icon::after {
                display: block;
                position: absolute;
                height: 3px;
                width: 100%;
                background: #0b3d1c;
                border-radius: 3px;
                transition: all 0.3s ease-in-out;
            }
            .hamburger-icon {
                top: 50%;
                transform: translateY(-50%);
            }
            .hamburger-icon::before {
                content: '';
                top: -9px;
            }
            .hamburger-icon::after {
                content: '';
                top: 9px;
            }
            .hamburger-icon.active { background: transparent; }
            .hamburger-icon.active::before { top: 0; transform: rotate(45deg); }
            .hamburger-icon.active::after { top: 0; transform: rotate(-45deg); }
            /* --- END HAMBURGER MENU STYLES --- */

            /* Other Mobile Optimizations */
            .top-header-bar {
                padding: 0 10px;
            }
            .card {
                padding: 20px;
                max-width: 100%;
                border-radius: 30px;
            }
            .card.expanded {
                max-width: 100%;
            }
            h2 { font-size: 24px; }
            input { padding: 12px; }
            .chart-container {
                height: 250px;
                width: 100%;
            }
            .result-value { font-size: 28px; }
            table { font-size: 11px; }
            .footer {
                font-size: 16px;
            }
            .emi-info {
                max-width: 100%;
                padding: 0 10px;
            }
        }
        /* --- END MOBILE OPTIMIZATION --- */
    </style>
</head>
<body>
    
    <header class="top-header-bar">
        <a href="#calculatorTitle" class="logo-text" onclick="closeMenu()">EMI Calculator</a>
        
        <button id="menuToggle" aria-label="Toggle navigation menu">
            <span class="hamburger-icon" id="hamburgerIcon"></span>
        </button>
        
        <nav class="top-nav" id="topNav">
    <a href="index.html" onclick="closeMenu()">Home</a>
    <a href="articles.html" onclick="closeMenu()">Articles</a>  <a href="about.html" onclick="closeMenu()">About us</a>
    <a href="contact.html" onclick="closeMenu()">Contact us</a>
    <a href="privacy.html" onclick="closeMenu()">Privacy Policy</a>
    <a href="terms.html" onclick="closeMenu()">Terms & Condition</a>
    </nav>
    </header>

    <div class="card-container">
        <div class="card" id="cardBox">
            <h2 id="calculatorTitle">📊 Loan (EMI) Calculator</h2>
            <label id="labelLoanAmount">Loan Amount (₹)</label>
            <input type="number" id="loanAmount" placeholder="Enter loan amount">
            <label id="labelInterestRate">Annual Interest Rate (%)</label>
            <input type="number" id="interestRate" step="0.01" placeholder="e.g. 8.5">
            <label id="labelLoanTenure">Loan Tenure (Years)</label>
            <input type="number" id="loanTenure" placeholder="e.g. 5">
            <div class="button-container">
                <button class="btn" id="calculateBtn" onclick="calculateEMI()">Calculate</button>
                <button class="btn btn-reset" id="resetBtn" style="display:none;" onclick="resetCalculator()">Reset</button>
            </div>
            
            <div class="results-and-chart-container" id="resultsAndChartContainer">
                <div class="results-content" id="results"></div>
                <div class="chart-container"><canvas id="emiChart"></canvas></div>
            </div>
            
            <div class="center-btn-wrapper">
                <button class="show-schedule-btn" id="showScheduleBtn" onclick="showAmortizationTable()">Show Amortization Schedule</button>
            </div>
            
            <div class="schedule-container" id="scheduleContainer">
                </div>
        </div>
        
        <div class="footer" id="footerLine">
            <span class="footer-content" id="footerText">🇮🇳 Made in India</span>
        </div>
        <div class="emi-info" id="emi-info-section">
            <h3 id="emiInfoTitle">What is EMI?</h3>
            <p id="emiInfoPara1">An <b>Equated Monthly Installment (EMI)</b> is a fixed payment you make to a lender each month to repay a loan over a set period. It's designed to simplify your repayment schedule by combining both the <b>principal loan amount</b> and the <b>interest</b> due into a single, predictable monthly payment.</p>
            <p id="emiInfoPara2">Think of it as a consistent, manageable sum that helps you systematically pay off your debt.</p>
            <p id="emiInfoPara3">Over time, the composition of your EMI changes. In the early stages of your loan, a larger portion of your EMI goes toward paying off the <b>interest</b>. As you continue to make payments, this proportion shifts, and a greater share of each EMI is allocated to reducing the <b>principal</b> balance. While the monthly amount you pay remains the same, the breakdown of principal and interest within that amount is constantly adjusting. This process is known as <b>amortization</b>.</p>
            <h4 id="emiFormulaTitle">The EMI Formula</h4>
            <p id="emiFormulaPara1">
            The standard formula for calculating is: EMI = [P x R x (1+R)^N] / [(1+R)^N-1]
            </p>
            <p id="emiFormulaPara2"></p>
            <p id="emiExamplePara">For example, if you borrow ₹10,00,000 at an annual interest rate of 10.5% for 10 years (120 months), your monthly EMI would be approximately ₹13,493. This means you will pay a total of ₹16,19,220 over the loan term, with ₹6,19,220 of that being the interest.</p>
            <p id="emiConclusionPara">Calculating this manually can be tedious and prone to errors. Our EMI calculator automates this process, providing you with instant, accurate results along with a detailed amortization schedule and visual charts to help you understand your loan repayment journey.</p>
        </div>
        <div class="orange-banner" id="faq-start">
        </div>
    </div>

    <div id="downloadModal" class="modal">
        <div class="modal-content">
            <h4>Download Your Amortization Schedule</h4>
            <p>Would you like to save this detailed repayment schedule as an <b>XLSX/Excel</b> document?</p>
            <button class="modal-download-btn" onclick="downloadXLSX()">Download Now</button>
            <button class="modal-close-btn" onclick="hideDownloadPopup()">No, thanks</button>
        </div>
    </div>
    
   <script>
        let chart;
        let amortizationData = []; 
        let currentLang = 'en';
        let popupTimeout; 

        const card = document.getElementById('cardBox');
        const resultsAndChartContainer = document.getElementById('resultsAndChartContainer');
        const scheduleContainer = document.getElementById('scheduleContainer');
        const showScheduleBtn = document.getElementById('showScheduleBtn');
        const resultsDiv = document.getElementById('results');
        const resetBtn = document.getElementById('resetBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const centerBtnWrapper = document.querySelector('.center-btn-wrapper');
        const downloadModal = document.getElementById('downloadModal');

        // JAVASCRIPT FOR HAMBURGER MENU
        const menuToggle = document.getElementById('menuToggle');
        const topNav = document.getElementById('topNav');
        const hamburgerIcon = document.getElementById('hamburgerIcon');

        function toggleMenu() {
            topNav.classList.toggle('active');
            hamburgerIcon.classList.toggle('active');
            document.body.style.overflow = topNav.classList.contains('active') ? 'hidden' : 'auto';
        }

        function closeMenu() {
            topNav.classList.remove('active');
            hamburgerIcon.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        menuToggle.addEventListener('click', toggleMenu);
        // END JAVASCRIPT FOR HAMBURGER MENU


        // --- Translation Data ---
        const translations = {
            en: {
                title: "📊 Loan (EMI) Calculator",
                loanAmount: "Loan Amount (₹)",
                interestRate: "Annual Interest Rate (%)",
                loanTenure: "Loan Tenure (Years)",
                calculate: "Calculate",
                reset: "Reset",
                monthlyEmi: "Monthly <strong>EMI</strong>:",
                totalPayment: "Total Payment:",
                totalInterest: "Total Interest:",
                amortizationSchedule: "📑 Amortization Schedule (Starting Next Month)",
                year: "Year",
                month: "Payment No", 
                paymentDate: "Payment Date", 
                principal: "Principal (₹)",
                interest: "Interest (₹)",
                balance: "Balance (₹)",
                madeInIndia: "🇮🇳 Made in India",
                chartPrincipal: "Principal",
                chartInterest: "Interest",
                showSchedule: "Show Amortization Schedule",
                hideSchedule: "Hide Amortization Schedule",
                infoTitle: "What is EMI?",
                infoPara1: "An <b>Equated Monthly Installment (EMI)</b> is a fixed payment you make to a lender each month to repay a loan over a set period. It's designed to simplify your repayment schedule by combining both the <b>principal loan amount</b> and the <b>interest</b> due into a single, predictable monthly payment.",
                infoPara2: "Think of it as a consistent, manageable sum that helps you systematically pay off your debt.",
                infoPara3: "Over time, the composition of your EMI changes. In the early stages of your loan, a larger portion of your EMI goes toward paying off the <b>interest</b>. As you continue to make payments, this proportion shifts, and a greater share of each EMI is allocated to reducing the <b>principal</b> balance. While the monthly amount you pay remains the same, the breakdown of principal and interest within that amount is constantly adjusting. This process is known as <b>amortization</b>.",
                formulaTitle: "The EMI Formula",
                formulaPara1: "The standard formula for calculating is: EMI = [P x R x (1+R)^N] / [(1+R)^N-1]",
                formulaPara2: "Where: <ul><li><b>P</b> = Principal Loan Amount</li><li><b>R</b> = Monthly Interest Rate (Annual Rate / 12 / 100)</li><li><b>N</b> = Loan Tenure in Months</li></ul>",
                examplePara: "For example, if you borrow ₹10,00,000 at an annual interest rate of 10.5% for 10 years (120 months), your monthly EMI would be approximately ₹13,493. This means you will pay a total of ₹16,19,220 over the loan term, with ₹6,19,220 of that being the interest.",
                conclusionPara: "Calculating this manually can be tedious and prone to errors. Our EMI calculator automates this process, providing you with instant, accurate results along with a detailed amortization schedule and visual charts to help you understand your loan repayment journey."
            },
            hi: {
                title: "📊 लोन (EMI) कैलकुलेटर",
                loanAmount: "लोन की राशि (₹)",
                interestRate: "वार्षिक ब्याज दर (%)",
                loanTenure: "लोन की अवधि (साल)",
                calculate: "गणना करें",
                reset: "रीसेट करें",
                monthlyEmi: "मासिक <strong>ईएमआई</strong>:",
                totalPayment: "कुल भुगतान:",
                totalInterest: "कुल ब्याज:",
                amortizationSchedule: "📑 चुकौती सारणी (अगले महीने से शुरू)",
                year: "वर्ष",
                month: "किस्त संख्या",
                paymentDate: "भुगतान की तिथि",
                principal: "मूलधन (₹)",
                interest: "ब्याज (₹)",
                balance: "बकाया (₹)",
                madeInIndia: "🇮🇳 भारत में निर्मित",
                chartPrincipal: "मूलधन",
                chartInterest: "ब्याज",
                showSchedule: "चुकौती सारणी दिखाएं",
                hideSchedule: "चुकौती सारणी छिपाएं", 
                infoTitle: "ईएमआई क्या है?",
                infoPara1: "<b>समान मासिक किस्त (ईएमआई)</b> एक निश्चित भुगतान है जो आप एक निश्चित अवधि में ऋण चुकाने के लिए हर महीने एक ऋणदाता को करते हैं। इसे आपके चुकौती कार्यक्रम को सरल बनाने के लिए डिज़ाइन किया गया है, जिसमें <b>मूल ऋण राशि</b> और देय <b>ब्याज</b> दोनों को एक ही, अनुमानित मासिक भुगतान में जोड़ा जाता है।",
                infoPara2: "इसे एक सुसंगत, प्रबंधनीय राशि के रूप में सोचें जो आपको व्यवस्थित रूप से अपना ऋण चुकाने में मदद करती है।",
                infoPara3: "ओवर टाइम, आपकी ईएमआई की संरचना बदल जाती है। आपके ऋण के शुरुआती चरणों में, आपकी ईएमआई का एक बड़ा हिस्सा <b>ब्याज</b> चुकाने में जाता है। जैसे-जैसे आप भुगतान करना जारी रखते हैं, यह अनुपात बदलता है, और प्रत्येक ईएमआई का एक बड़ा हिस्सा <b>मूलधन</b> शेष को कम करने के लिए आवंटित किया जाता है। इस प्रक्रिया को <b>ऋण परिशोधन</b> कहा जाता है।",
                formulaTitle: "ईएमआई सूत्र",
                formulaPara1: "मानक सूत्र है: EMI = [P x R x (1+R)^N] / [(1+R)^N-1]",
                formulaPara2: "जहां: <ul><li><b>P</b> = मूल ऋण राशि</li><li><b>R</b> = मासिक ब्याज दर (वार्षिक दर / 12 / 100)</li><li><b>N</b> = महीनों में ऋण अवधि</li></ul>",
                examplePara: "उदाहरण के लिए, यदि आप 10 साल (120 महीने) के लिए 10.5% की वार्षिक ब्याज दर पर ₹10,00,000 उधार लेते हैं, तो आपकी मासिक ईएमआई लगभग ₹13,493 होगी। इसका मतलब है कि आप ऋण अवधि के दौरान कुल ₹16,19,220 का भुगतान करेंगे, जिसमें से ₹6,19,220 ब्याज होगा।",
                conclusionPara: "Calculating this manually can be tedious and prone to errors. Our EMI calculator automates this process, providing you with instant, accurate results along as with a detailed amortization schedule and visual charts to help you understand your loan repayment journey."
            }
        };

        // Function to format numbers with commas and currency (Retained for display)
        function formatCurrency(amount) {
            return Math.round(amount).toLocaleString('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0
            }).replace('₹', '₹ ');
        }
        
        // Helper function to get a clean number for Excel
        function cleanNumber(amount) {
            // Round to 2 decimal places for accuracy in a spreadsheet
            return Math.round(amount * 100) / 100;
        }
        
        // --- Core EMI Calculation Logic (Retained) ---
        function calculateEMI() {
            const P = parseFloat(document.getElementById('loanAmount').value);
            const r = parseFloat(document.getElementById('interestRate').value) / 100 / 12; // Monthly rate
            const n = parseFloat(document.getElementById('loanTenure').value) * 12; // Total months

            // Input Validation
            if (isNaN(P) || isNaN(r) || isNaN(n) || P <= 0 || r <= 0 || n <= 0) {
                alert("Please enter valid positive numbers for all fields.");
                return;
            }

            // EMI Formula: M = P [ R(1 + R)^N / ((1 + R)^N – 1) ]
            const emi = P * r * (Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
            
            // Calculate Totals and Amortization Schedule
            let totalInterest = 0;
            let totalPayment = emi * n;
            let balance = P;
            amortizationData = []; // Reset schedule
            
            // Set Start Date for Amortization
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() + 1);
            startDate.setDate(1); 
            
            for (let i = 1; i <= n; i++) {
                let paymentDate = new Date(startDate);
                paymentDate.setMonth(startDate.getMonth() + i - 1);
                
                const interestPayment = balance * r;
                const principalPayment = emi - interestPayment;
                const newBalance = balance - principalPayment;

                totalInterest += interestPayment;
                
                const locale = currentLang === 'hi' ? 'hi-IN' : 'en-US';

                amortizationData.push({
                    month: i,
                    date: paymentDate.toLocaleDateString(locale, { year: 'numeric', month: 'long' }),
                    principal: principalPayment,
                    interest: interestPayment,
                    balance: newBalance > 0 ? newBalance : 0 
                });
                
                balance = newBalance;
            }

            // Display Results
            displayResults(emi, totalPayment, totalInterest);
            drawChart(P, totalInterest);
            
            // UI Updates
            card.classList.add('expanded');
            resultsAndChartContainer.classList.add('show');
            centerBtnWrapper.style.display = 'flex'; 
            resetBtn.style.display = 'block';
            calculateBtn.style.display = 'none';

            // Hide schedule and cancel any pending popup if recalculating
            scheduleContainer.classList.remove('show');
            showScheduleBtn.textContent = translations[currentLang].showSchedule;
            hideDownloadPopup();

             // Scroll to results
             document.getElementById('resultsAndChartContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // --- Download Popup Functions ---
        function showDownloadPopup() {
            // Check if the amortization table is still visible before showing the popup
            if (scheduleContainer.classList.contains('show')) {
                downloadModal.style.display = 'flex';
            }
        }

        function hideDownloadPopup() {
            clearTimeout(popupTimeout); // Cancel any pending timeout
            downloadModal.style.display = 'none';
        }

        // --- NEW XLSX/CSV Download Function ---
        function downloadXLSX() {
            hideDownloadPopup();
            
            const T = translations[currentLang];

            // 1. Define Headers (cleaner text for spreadsheet columns)
            const headers = [
                `"${T.month}"`,
                `"${T.paymentDate}"`,
                `"${T.principal.replace(' (₹)', '')}"`,
                `"${T.interest.replace(' (₹)', '')}"`,
                `"${T.balance.replace(' (₹)', '')}"`
            ];

            // 2. Generate CSV Content (Header + Rows)
            let csv = headers.join(',') + '\n';

            amortizationData.forEach(data => {
                const row = [
                    data.month,
                    `"${data.date}"`, // Enclose date in quotes for CSV compatibility
                    cleanNumber(data.principal),
                    cleanNumber(data.interest),
                    cleanNumber(data.balance)
                ];
                csv += row.join(',') + '\n';
            });

            // 3. Create Blob and Download (.csv is universal and opens in Excel)
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "Amortization_Schedule.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        // --- END NEW XLSX/CSV Download Function ---


        // --- Amortization Table Logic (Retained) ---
        function showAmortizationTable() {
            const T = translations[currentLang];

            // If schedule is currently showing, hide it and the popup
            if (scheduleContainer.classList.contains('show')) {
                scheduleContainer.classList.remove('show');
                showScheduleBtn.textContent = T.showSchedule;
                hideDownloadPopup(); // Hide popup and cancel timer
                return;
            }
            
            // Otherwise, generate and show the schedule
            let tableHTML = `
                <h3>${T.amortizationSchedule}</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                <table id="amortizationTable">
                    <thead>
                        <tr>
                            <th>${T.month}</th> 
                            <th>${T.paymentDate}</th> 
                            <th>${T.principal}</th>
                            <th>${T.interest}</th>
                            <th>${T.balance}</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            amortizationData.forEach(data => {
                tableHTML += `
                    <tr>
                        <td>${data.month}</td>
                        <td>${data.date}</td> 
                        <td>${formatCurrency(data.principal)}</td>
                        <td>${formatCurrency(data.interest)}</td>
                        <td>${formatCurrency(data.balance)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;

            scheduleContainer.innerHTML = tableHTML;
            scheduleContainer.classList.add('show');
            showScheduleBtn.textContent = T.hideSchedule; 

            // Scroll to the schedule table
            scheduleContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Show download popup after 10 seconds
            popupTimeout = setTimeout(showDownloadPopup, 10000);
        }

        // --- Other functions (Retained for completeness) ---
        function displayResults(emi, totalPayment, totalInterest) {
            const T = translations[currentLang];

            resultsDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label highlighted">${T.monthlyEmi}</span>
                    <span class="result-value highlighted">${formatCurrency(emi)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${T.totalPayment}</span>
                    <span class="result-value">${formatCurrency(totalPayment)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">${T.totalInterest}</span>
                    <span class="result-value">${formatCurrency(totalInterest)}</span>
                </div>
            `;
        }

        function drawChart(P, totalInterest) {
            const ctx = document.getElementById('emiChart').getContext('2d');
            const T = translations[currentLang];

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [T.chartPrincipal, T.chartInterest],
                    datasets: [{
                        data: [P, totalInterest],
                        backgroundColor: ['#0b3d1c', '#ff6600'],
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 14,
                                    family: "'Poppins', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Total Payment Breakdown',
                            font: {
                                size: 18,
                                family: "'Poppins', sans-serif",
                                weight: '600'
                            },
                            color: '#333'
                        }
                    }
                }
            });
        }
        
        function resetCalculator() {
            document.getElementById('loanAmount').value = '';
            document.getElementById('interestRate').value = '';
            document.getElementById('loanTenure').value = '';
            
            // Clear results and chart
            resultsDiv.innerHTML = '';
            scheduleContainer.innerHTML = '';
            if (chart) {
                chart.destroy();
                chart = null;
            }
            
            // UI Updates
            card.classList.remove('expanded');
            resultsAndChartContainer.classList.remove('show');
            centerBtnWrapper.style.display = 'none'; 
            resetBtn.style.display = 'none';
            calculateBtn.style.display = 'block';
            scheduleContainer.classList.remove('show');
            
            // Hide the download modal and cancel the timer
            hideDownloadPopup();
        }

        function setLanguage(lang) {
            currentLang = lang || 'en'; 
            
            const T = translations[currentLang];
            
            // Update UI text 
            document.getElementById('calculatorTitle').textContent = T.title;
            document.getElementById('labelLoanAmount').textContent = T.loanAmount;
            document.getElementById('labelInterestRate').textContent = T.interestRate;
            document.getElementById('labelLoanTenure').textContent = T.loanTenure;
            document.getElementById('calculateBtn').textContent = T.calculate;
            document.getElementById('resetBtn').textContent = T.reset;
            document.getElementById('showScheduleBtn').textContent = scheduleContainer.classList.contains('show') ? T.hideSchedule : T.showSchedule;
            
            // Update EMI Info section
            document.getElementById('emiInfoTitle').textContent = T.infoTitle;
            document.getElementById('emiInfoPara1').innerHTML = T.infoPara1;
            document.getElementById('emiInfoPara2').innerHTML = T.infoPara2;
            document.getElementById('emiInfoPara3').innerHTML = T.infoPara3;
            document.getElementById('emiFormulaTitle').textContent = T.formulaTitle;
            document.getElementById('emiFormulaPara1').textContent = T.formulaPara1;
            document.getElementById('emiFormulaPara2').innerHTML = T.formulaPara2;
            document.getElementById('emiExamplePara').textContent = T.examplePara;
            document.getElementById('emiConclusionPara').textContent = T.conclusionPara;
            document.getElementById('footerText').textContent = T.madeInIndia;
            
            // If results are showing, redraw them in the new language
            if (resultsAndChartContainer.classList.contains('show')) {
                calculateEMI(); 
            }
        }
        
        // Initial setup
        setLanguage('en'); 
    </script>

</body>
</html>
